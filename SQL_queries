# Descriptive statistics 

SELECT COUNT (DISTINCT film_id) AS film_cnt,
COUNT (rental_duration) AS rent_duration_cnt,
ROUND (AVG (rental_duration), 3) AS avg_rent_duration,
MIN (rental_duration) AS min_rent_duration,
MAX (rental_duration) AS max_rent_duration,
COUNT (rental_rate) AS rent_rate_cnt,
ROUND (AVG (rental_rate), 3) AS avg_rent_rate,
MIN (rental_rate) AS min_rent_rate,
MAX (rental_rate) AS max_rent_rate,
COUNT (length) AS length_cnt,
ROUND (AVG (length), 3) AS avg_length,
MIN (length) AS min_length,
MAX (length) AS max_length
FROM film;

# Top-10 movies

SELECT A.title AS film_title, 
F.name AS genre,
A.rental_rate AS rent_rate,
A.rating,
COUNT (payment_id) AS tx_cnt,
SUM (D.amount) AS total_revenue
FROM film A
JOIN inventory B ON A.film_id = B.film_id
JOIN rental C ON B.inventory_id = C.inventory_id
JOIN payment D ON C.rental_id = D.rental_id
JOIN film_category E ON A.film_id = E.film_id
JOIN category F ON E.category_id = F.category_id
GROUP BY A.title, F.name, A.rental_rate, A.rating
ORDER BY total_revenue DESC
LIMIT 10;

# Countries by the number of customers, revenue generates and the percentage in revenue

SELECT D.country, 
COUNT (DISTINCT A.customer_id) AS customer_cnt,
SUM (E.amount) AS total_revenue,
ROUND (SUM (E.amount) / (SELECT SUM (E.amount) FROM payment E)*100,2) AS Percentage_revenue
FROM customer A
JOIN address B ON A.address_id = B.address_id
JOIN city C ON B.city_id = C.city_id
JOIN country D ON C.country_id = D.country_id
JOIN payment E ON A.customer_id = E.customer_id
GROUP BY D.country
ORDER BY total_revenue DESC;

# Percentage in total revenue generated by top-10 countries

WITH TopCountries
AS (SELECT D.country, SUM (E.amount) 
   FROM payment E
   JOIN customer A ON E.customer_id = A.customer_id
   JOIN address B ON A.address_id = B.address_id
   JOIN city C ON B.city_id = C.city_id
   JOIN country D ON C.country_id = D.country_id
   GROUP BY D.country
   ORDER BY SUM (E.amount) DESC LIMIT 10)
SELECT 
ROUND (SUM (E.amount) / (SELECT SUM (E.amount) FROM payment E)*100,2) AS Percentage_revenue
FROM customer A
JOIN address B ON A.address_id = B.address_id
JOIN city C ON B.city_id = C.city_id
JOIN country D ON C.country_id = D.country_id
JOIN payment E ON A.customer_id = E.customer_id
WHERE D.country IN (SELECT country FROM TopCountries)

# Top-10 cities from the list of top countries

SELECT D.country, C.city, COUNT (DISTINCT A.customer_id) AS customer_cnt 
FROM customer A
JOIN address B ON A.address_id = B.address_id
JOIN city C ON B.city_id = C.city_id
JOIN country D ON C.country_id = D.country_id
WHERE D.country IN (SELECT D.country
						FROM customer A
						JOIN address B ON A.address_id = B.address_id
						JOIN city C ON B.city_id = C.city_id
						JOIN country D ON C.country_id = D.country_id
						GROUP BY D.country
						ORDER BY COUNT (A.customer_id) DESC LIMIT 10)
GROUP BY C.city, D.country
ORDER BY customer_cnt DESC LIMIT 10;

# Top-5 customers in the top cities

SELECT A.customer_id, A.first_name, A.last_name, D.country, 
SUM (E.amount) AS total_amount_spent
FROM customer A
JOIN address B ON A.address_id = B.address_id
JOIN city C ON B.city_id = C.city_id
JOIN country D ON C.country_id = D.country_id
JOIN payment E ON A.customer_id = E.customer_id
WHERE C.city IN (SELECT C.city
				FROM customer A
				JOIN address B ON A.address_id = B.address_id
				JOIN city C ON B.city_id = C.city_id
				JOIN country D ON C.country_id = D.country_id
				WHERE D.country IN (SELECT D.country
									FROM customer A
									JOIN address B ON A.address_id = B.address_id
									JOIN city C ON B.city_id = C.city_id
									JOIN country D ON C.country_id = D.country_id
									GROUP BY D.country
									ORDER BY COUNT (A.customer_id) DESC LIMIT 10)
				GROUP BY D.country, C.city
				ORDER BY COUNT (A.customer_id) DESC LIMIT 10)
GROUP BY A.customer_id, C.city, D.country
ORDER BY SUM (E.amount) DESC LIMIT 5;

# Top-10 customers by revenue generated

SELECT A.customer_id, A.first_name, A.last_name, D.country, C.city, 
SUM (E.amount) AS total_revenue
FROM customer A
JOIN address B ON A.address_id = B.address_id
JOIN city C ON B.city_id = C.city_id
JOIN country D ON C.country_id = D.country_id
JOIN payment E ON A.customer_id = E.customer_id
GROUP BY A.customer_id, A.first_name, A.last_name, D.country, C.city
ORDER BY total_revenue DESC
LIMIT 10;

# The most popular genre in each of top countries

WITH TopCountries
AS (SELECT I.country, SUM (A.amount) 
   FROM payment A
   JOIN customer F ON A.customer_id = F.customer_id
   JOIN address G ON F.address_id = G.address_id
   JOIN city H ON G.city_id = H.city_id
   JOIN country I ON H.country_id = I.country_id
   GROUP BY I.country
   ORDER BY SUM (A.amount) DESC LIMIT 10),
Ranking 
AS (SELECT I.country, E.name AS genre, SUM (A.amount) AS total_revenue,
   RANK () OVER (PARTITION BY I.country ORDER BY SUM (A.amount) DESC) AS revenue_rank
   FROM payment A
   JOIN rental B ON A.rental_id = B.rental_id
   JOIN inventory C ON B.inventory_id = C.inventory_id
   JOIN film_category D ON C.film_id = D.film_id
   JOIN category E ON D.category_id = E.category_id
   JOIN customer F ON A.customer_id = F.customer_id
   JOIN address G ON F.address_id = G.address_id
   JOIN city H ON G.city_id = H.city_id
   JOIN country I ON H.country_id = I.country_id
   WHERE I.country IN (SELECT country FROM TopCountries)
   GROUP BY I.country, E.name)	
SELECT country, genre, total_revenue
FROM Ranking
WHERE revenue_rank = 1
ORDER BY country, total_revenue DESC

# Films not rented

SELECT A.film_id, A.title, C.rental_id
FROM film A
LEFT JOIN inventory B ON A.film_id = B.film_id
LEFT JOIN rental C ON B.inventory_id = C.inventory_id
WHERE C.rental_id IS NULL
GROUP BY A.film_id, A.title, C.rental_id

# Films rented less than 10 orders

SELECT A.film_id, A.title, COUNT (DISTINCT C.rental_id) AS rental_cnt
FROM film A
JOIN inventory B ON A.film_id = B.film_id
JOIN rental C ON B.inventory_id = C.inventory_id
GROUP BY A.film_id, A.title
HAVING COUNT (DISTINCT C.rental_id) < 10
ORDER BY rental_cnt

